# Database Architecture Documentation

## Current Implementation: In-Memory Database

The ChiHealth MediSecure backend currently uses an **in-memory database** implementation. This means:

- **Data Storage**: All data is stored in JavaScript arrays/objects in memory (see `backend/src/db.ts`)
- **Data Persistence**: Data is **NOT persisted** between server restarts
- **Seed Data**: Initial data is generated by `backend/prisma/seed.ts` and loaded into memory on server startup
- **Use Case**: This approach is suitable for:
  - Development and testing
  - Prototyping
  - Demonstrations
  - Not suitable for production with real patient data

### How It Works

1. On server startup, `backend/src/db.ts` calls `seedData()` from `prisma/seed.ts`
2. Seed data is loaded into in-memory arrays (users, appointments, prescriptions, etc.)
3. All database operations (CRUD) are performed on these in-memory arrays
4. Data is lost when the server stops

### Advantages of Current Approach

- ✅ Fast development setup - no database installation required
- ✅ Simple to understand and modify
- ✅ Good for testing and demos
- ✅ No database migrations needed
- ✅ Easy to reset data (just restart server)

### Limitations

- ❌ Data doesn't persist between restarts
- ❌ Not suitable for production
- ❌ No concurrent access handling
- ❌ Limited scalability
- ❌ No data integrity guarantees
- ❌ Cannot handle multiple server instances

## Future Migration: Prisma + PostgreSQL

The project includes a Prisma schema (`backend/prisma/schema.prisma`) that defines the database structure for a future PostgreSQL migration.

### Prisma Schema Status

- **Location**: `backend/prisma/schema.prisma`
- **Status**: **NOT CURRENTLY USED** - provided for reference
- **Purpose**: Defines the database schema for future migration

### Migration Path

To migrate from in-memory to PostgreSQL:

1. **Install Prisma Client**:
   ```bash
   cd backend
   npm install @prisma/client
   ```

2. **Set up PostgreSQL Database**:
   - Use the existing Docker Compose setup (already configured)
   - Or set up a managed PostgreSQL instance (e.g., GCP Cloud SQL)

3. **Generate Prisma Client**:
   ```bash
   npx prisma generate
   ```

4. **Run Migrations**:
   ```bash
   npx prisma migrate dev --name init
   ```

5. **Update `backend/src/db.ts`**:
   - Replace in-memory array operations with Prisma client calls
   - Example:
     ```typescript
     // Before (in-memory)
     export const findUserById = async (id: string): Promise<User | undefined> => 
       users.find(u => u.id === id);
     
     // After (Prisma)
     export const findUserById = async (id: string): Promise<User | undefined> => 
       await prisma.user.findUnique({ where: { id } });
     ```

6. **Seed Production Database**:
   - Run `npx prisma db seed` to populate initial data
   - Or adapt `prisma/seed.ts` to work with Prisma

7. **Update Environment Variables**:
   - Ensure `DATABASE_URL` is set correctly
   - Update `.env` or Docker Compose configuration

### Database Schema

The Prisma schema includes models for:
- Organizations (with hierarchical relationships)
- Users (with role-based access)
- Appointments
- Prescriptions
- Lab Tests
- Clinical Notes
- Messages
- Bills
- Referrals
- Departments
- Rooms and Beds
- Transport Requests
- Activity Logs

### Why PostgreSQL?

- **ACID Compliance**: Ensures data integrity
- **Scalability**: Can handle concurrent users and large datasets
- **Persistence**: Data survives server restarts
- **Production Ready**: Suitable for healthcare applications
- **Relationships**: Proper foreign key constraints
- **Query Optimization**: Efficient queries with indexes

## Docker Compose Setup

The project includes a `docker-compose.yml` that sets up:
- PostgreSQL database (port 5432)
- Backend service (port 8080)
- Frontend service (port 80)

The PostgreSQL database is configured but **not currently used** by the backend. Once migrated to Prisma, the backend will connect to this database.

## Recommendations

### For Development/Testing
- Continue using in-memory database for rapid iteration
- Use seed data for consistent test scenarios

### For Production
- **Must migrate to PostgreSQL** before handling real patient data
- Implement proper database backups
- Set up database migrations workflow
- Configure connection pooling
- Implement proper error handling and transaction management

## Security Considerations

⚠️ **Important**: The current in-memory implementation should **NEVER** be used in production with real Protected Health Information (PHI). It lacks:
- Data encryption at rest
- Audit logging
- Access controls
- Data backup and recovery
- HIPAA compliance features

All these features are available with PostgreSQL and proper database configuration.

